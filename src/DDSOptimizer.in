#!/usr/bin/env @PYTHON@

import sys, getopt
sys.path.insert(1, '@pythondir@')

import tensorflow as tf
import numpy as np

import time

from DataDrivenSampler.common import get_filename_from_fullpath
from DataDrivenSampler.DataOptimizer import parse_parameters
from DataDrivenSampler.models.model import model
from DataDrivenSampler.version import get_package_version, get_build_hash
from DataDrivenSampler.runtime.runtime import runtime

FLAGS = None

def main(_):
    rt = runtime(FLAGS)

    time_zero = time.process_time()

    network_model = model(FLAGS)

    time_init_network_zero = time.process_time()

    network_model.init_network(FLAGS.restore_model, setup="train")

    rt.set_init_network_time(time.process_time() - time_init_network_zero)

    network_model.train()

    rt.set_train_network_time(time.process_time() - rt.time_init_network)

    network_model.finish()

    rt.set_overall_time(time.process_time() - time_zero)

if __name__ == '__main__':
    FLAGS, unparsed = parse_parameters()

    if FLAGS.version:
        # give version and exit
        print(get_filename_from_fullpath(sys.argv[0])+" "+get_package_version()+" -- version "+get_build_hash())
        sys.exit(0)

    print("Using parameters: "+str(FLAGS))

    if FLAGS.batch_size is None:
        print("No batch_size was specified, using true gradients.")
        FLAGS.batch_size = FLAGS.dimension

    if len(unparsed) != 0:
        print("There are unparsed parameters '"+str(unparsed)+"', have you misspelled some?")
        sys.exit(255)

    tf.app.run(main=main, argv=[sys.argv[0]] + unparsed)

