#!/usr/bin/env @PYTHON@

import sys, getopt
sys.path.insert(1, '@pythondir@')

import tensorflow as tf
import numpy as np

from DataDrivenSampler.version import get_package_version, get_build_hash
from DataDrivenSampler.DataDrivenSampler import parse_parameters, sample, setup_output_files
from DataDrivenSampler.common import create_classification_dataset, closeFiles, \
    construct_network_model, get_activations, get_filename_from_fullpath, initialize_config_map

FLAGS = None

def main(_):
    config_map = initialize_config_map()

    # init random: None will use random seed
    if FLAGS.seed is not None:
        np.random.seed(FLAGS.seed)

    xinput, x, ds = create_classification_dataset(FLAGS, config_map)

    with tf.variable_scope("accumulate"):
        kinetic_energy_t = tf.get_variable("kinetic", shape=[], trainable=False,
                                           initializer=tf.zeros_initializer,
                                           use_resource=True)
        momenta_t = tf.get_variable("momenta", shape=[], trainable=False,
                                           initializer=tf.zeros_initializer,
                                           use_resource=True)
        gradients_t = tf.get_variable("gradients", shape=[], trainable=False,
                                           initializer=tf.zeros_initializer,
                                           use_resource=True)
        noise_t = tf.get_variable("noise", shape=[], trainable=False,
                                           initializer=tf.zeros_initializer,
                                           use_resource=True)

    activations = get_activations()
    nn = construct_network_model(FLAGS, config_map, x,
                                 hidden_activation=activations[FLAGS.hidden_activation],
                                 output_activation=activations[FLAGS.output_activation],
                                 loss_name=FLAGS.loss)

    csv_writer, trajectory_writer = \
        setup_output_files(FLAGS, nn, config_map)

    sess = tf.Session(
        config=tf.ConfigProto(
            intra_op_parallelism_threads = None,
            inter_op_parallelism_threads = 1))
    nn.init_graph(sess)

    sample(FLAGS, ds, sess, nn, xinput, csv_writer, trajectory_writer, config_map)

    closeFiles(config_map)

if __name__ == '__main__':
    FLAGS, unparsed = parse_parameters()

    if FLAGS.version:
        # give version and exit
        print(get_filename_from_fullpath(sys.argv[0])+" "+get_package_version()+" -- version "+get_build_hash())
        sys.exit(0)

    print("Using parameters: "+str(FLAGS))

    tf.app.run(main=main, argv=[sys.argv[0]] + unparsed)


